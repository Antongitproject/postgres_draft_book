
Сетевые настройки играют важную роль в производительности и стабильности PostgreSQL, особенно при большом количестве сетевых подключений или при высоких требованиях к времени отклика. Вот более детальное описание параметров и их настройки:

Основные сетевые параметры для настройки
1. net.core.somaxconn
Этот параметр определяет максимальное количество отложенных запросов на подключение, которые могут быть поставлены в очередь в ожидании обслуживания процессом слушателя (например, PostgreSQL).

Описание: Увеличение значения somaxconn позволяет PostgreSQL принимать больше подключений одновременно, что полезно для систем с высокой нагрузкой на подключения.
Рекомендуемое значение:

sysctl -w net.core.somaxconn=1024
2. net.ipv4.tcp_keepalive_time
Этот параметр определяет интервал времени (в секундах), который должен пройти до начала отправки keepalive сообщений на неактивном TCP-соединении.

Описание: Настройка tcp_keepalive_time помогает поддерживать активные соединения и обнаруживать недоступные клиенты.
Рекомендуемое значение:

sysctl -w net.ipv4.tcp_keepalive_time=7200
3. net.ipv4.tcp_keepalive_intvl
Этот параметр задает интервал времени (в секундах) между последующими keepalive сообщениями, если не получен ответ на предыдущее keepalive сообщение.

Рекомендуемое значение:

sysctl -w net.ipv4.tcp_keepalive_intvl=75
4. net.ipv4.tcp_keepalive_probes
Этот параметр определяет количество keepalive сообщений, отправленных без ответа, прежде чем считать соединение мертвым и закрыть его.

Рекомендуемое значение:

sysctl -w net.ipv4.tcp_keepalive_probes=9
5. net.core.netdev_max_backlog
Этот параметр определяет максимальное количество пакетов, которые могут быть поставлены в очередь сетевым интерфейсом, пока они ожидают обработки.

Описание: Увеличение значения netdev_max_backlog может помочь избежать потери пакетов при высоких нагрузках сети.
Рекомендуемое значение:

sysctl -w net.core.netdev_max_backlog=10000
6. net.ipv4.tcp_rmem и net.ipv4.tcp_wmem
Эти параметры определяют минимальный, начальный (по умолчанию) и максимальный размер буферов для чтения и записи TCP-соединений соответственно.

Описание: Настройка этих параметров позволяет лучше управлять памятью для TCP-соединений, что может улучшить производительность сетевых операций PostgreSQL.
Рекомендуемое значение:

sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"
7. net.ipv4.tcp_max_syn_backlog
Этот параметр определяет максимальное количество соединений, которые могут быть поставлены в очередь после получения SYN пакета (до того, как соединение будет установлено).

Описание: Увеличение значения tcp_max_syn_backlog помогает справляться с большим количеством входящих соединений.
Рекомендуемое значение:

sysctl -w net.ipv4.tcp_max_syn_backlog=4096
Применение настроек
После изменения параметров, их можно временно применить с помощью команды sysctl, как показано выше. Чтобы настройки сохранились после перезагрузки, добавьте их в файл /etc/sysctl.conf:


net.core.somaxconn = 1024
net.ipv4.tcp_keepalive_time = 7200
net.ipv4.tcp_keepalive_intvl = 75
net.ipv4.tcp_keepalive_probes = 9
net.core.netdev_max_backlog = 10000
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_max_syn_backlog = 4096
Примените настройки:


sysctl -p
Настройка PostgreSQL
Кроме настройки параметров операционной системы, необходимо также настроить сам PostgreSQL для работы с оптимизированными сетевыми параметрами.

Параметры конфигурации PostgreSQL в postgresql.conf:

listen_addresses = '*'
max_connections = 1000
Эти параметры помогают оптимизировать сетевую производительность PostgreSQL и обеспечивают лучшую устойчивость при высоких нагрузках.