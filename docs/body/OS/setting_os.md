Настройка операционной системы для оптимальной работы PostgreSQL включает несколько ключевых параметров, которые могут значительно улучшить производительность базы данных. Вот некоторые из основных параметров и рекомендаций:

1. Настройки памяти
a. Общие настройки памяти
vm.overcommit_memory:

Рекомендуется установить в 2 для более строгого управления выделением памяти.

sysctl -w vm.overcommit_memory=2
vm.swappiness:

Установите в 1 или 10 для минимизации использования swap.

sysctl -w vm.swappiness=1
vm.dirty_background_ratio и vm.dirty_ratio:

Эти параметры контролируют, когда фоновые и активные процессы начинают сбрасывать данные на диск.

sysctl -w vm.dirty_background_ratio=5
sysctl -w vm.dirty_ratio=15
b. Настройки больших страниц
vm.nr_hugepages:
Рассчитайте необходимое количество больших страниц, как обсуждалось ранее, и установите соответствующее значение.

sysctl -w vm.nr_hugepages=16384

Настройка памяти для оптимальной работы PostgreSQL включает несколько ключевых параметров, которые позволяют эффективно управлять использованием оперативной памяти и минимизировать использование swap. Вот подробное объяснение каждого параметра:

Общие настройки памяти
1. vm.overcommit_memory
Этот параметр контролирует политику выделения памяти ядром.

Значения:

0: Параметр по умолчанию. Ядро пытается угадать, сколько памяти требуется процессам.
1: Ядро разрешает выделение памяти с превышением реальной физической памяти.
2: Ядро запрещает выделение памяти с превышением реальной физической памяти. Рекомендуется для систем с базами данных, так как позволяет избежать ситуаций, когда PostgreSQL пытается использовать больше памяти, чем доступно.
Рекомендуемое значение:

sysctl -w vm.overcommit_memory=2
2. vm.swappiness
Этот параметр определяет, как агрессивно ядро будет использовать swap пространство. Значение от 0 до 100, где 0 означает минимальное использование swap.

Рекомендуемое значение:
sysctl -w vm.swappiness=1

3. vm.dirty_background_ratio и vm.dirty_ratio
Эти параметры управляют поведением ядра при записи данных на диск.
vm.dirty_background_ratio: Процент памяти, при достижении которого фоновые процессы начинают сбрасывать данные на диск.

Рекомендуемое значение:
sysctl -w vm.dirty_background_ratio=5
vm.dirty_ratio: Процент памяти, при достижении которого все процессы начинают сбрасывать данные на диск.

Рекомендуемое значение:
sysctl -w vm.dirty_ratio=15

Настройки больших страниц
Большие страницы (Huge Pages) позволяют улучшить производительность за счет уменьшения накладных расходов на управление памятью.

1. Размер одной большой страницы
В Linux стандартный размер большой страницы составляет 2MB, но это можно проверить с помощью команды:

grep Hugepagesize /proc/meminfo
2. Определение общего объема памяти, используемой PostgreSQL
Основное внимание нужно уделить параметру shared_buffers в конфигурации PostgreSQL.


shared_buffers = 32GB  # Пример
3. Расчет необходимого количества больших страниц
Формула: необходимое количество больших страниц = shared_buffers / размер большой страницы

# Например, при shared_buffers = 32GB и размере большой страницы 2MB:
32GB = 32 * 1024MB = 32768MB
необходимое количество больших страниц = 32768MB / 2MB = 16384
4. Настройка количества больших страниц в системе
Установите параметр vm.nr_hugepages:

sysctl -w vm.nr_hugepages=16384
Пример настройки в файле /etc/sysctl.conf
Чтобы настройки сохранялись после перезагрузки, добавьте их в файл /etc/sysctl.conf:


vm.overcommit_memory = 2
vm.swappiness = 1
vm.dirty_background_ratio = 5
vm.dirty_ratio = 15
vm.nr_hugepages = 16384
Проверка использования больших страниц
После настройки и перезапуска PostgreSQL, вы можете проверить использование больших страниц с помощью команды:


grep Huge /proc/meminfo
Настройка PostgreSQL для использования больших страниц
Добавьте или измените параметр huge_pages в конфигурационном файле PostgreSQL (postgresql.conf):


huge_pages = on
После внесения изменений перезапустите PostgreSQL для применения настроек.

Эти настройки помогут вам оптимизировать использование оперативной памяти, что приведет к улучшению производительности и стабильности работы PostgreSQL.

2. Настройки процессора
sched_min_granularity_ns и sched_latency_ns:
Эти параметры могут улучшить производительность при высоких нагрузках.

sysctl -w kernel.sched_min_granularity_ns=10000000
sysctl -w kernel.sched_latency_ns=20000000
3. Настройки дисковой подсистемы
noop или deadline I/O планировщик:

Для PostgreSQL часто рекомендуется использовать deadline или noop I/O планировщики.
Установите планировщик для нужного устройства:

echo deadline > /sys/block/sdX/queue/scheduler
Увеличение количества открытых файлов:

Увеличьте лимит на количество открытых файлов, особенно если вы ожидаете большое количество подключений.

ulimit -n 65536
fs.aio-max-nr:

Установите это значение в 1048576 или выше для улучшения асинхронного ввода-вывода.

sysctl -w fs.aio-max-nr=1048576
4. Сетевые настройки
net.core.somaxconn:

Увеличьте лимит на количество входящих соединений.

sysctl -w net.core.somaxconn=1024
net.ipv4.tcp_keepalive_time, tcp_keepalive_intvl, tcp_keepalive_probes:

Настройте параметры keepalive для поддержания соединений.

sysctl -w net.ipv4.tcp_keepalive_time=7200
sysctl -w net.ipv4.tcp_keepalive_intvl=75
sysctl -w net.ipv4.tcp_keepalive_probes=9
5. Настройки файловой системы
Монтажные опции:
Используйте noatime для уменьшения количества операций записи.
Пример монтирования:

mount -o noatime /dev/sdX /mountpoint
6. Безопасность и лимиты
Настройки ограничений в limits.conf:
Добавьте или измените лимиты в /etc/security/limits.conf для PostgreSQL:

postgres soft nofile 65536
postgres hard nofile 65536
postgres soft nproc 4096
postgres hard nproc 4096
Применение настроек
После изменения параметров в файлах конфигурации, таких как /etc/sysctl.conf и /etc/security/limits.conf, убедитесь, что изменения применены:


sysctl -p
Также, если вы изменили лимиты в limits.conf, может понадобиться перезапустить сеанс или систему для применения этих изменений.

Эти рекомендации помогут вам оптимизировать операционную систему для работы с PostgreSQL, улучшив производительность и стабильность базы данных.






