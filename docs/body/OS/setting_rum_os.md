Настройки памяти
a. Общие настройки памяти
vm.overcommit_memory:

Рекомендуется установить в 2 для более строгого управления выделением памяти.

sysctl -w vm.overcommit_memory=2
vm.swappiness:

Установите в 1 или 10 для минимизации использования swap.

sysctl -w vm.swappiness=1
vm.dirty_background_ratio и vm.dirty_ratio:

Эти параметры контролируют, когда фоновые и активные процессы начинают сбрасывать данные на диск.

sysctl -w vm.dirty_background_ratio=5
sysctl -w vm.dirty_ratio=15
b. Настройки больших страниц
vm.nr_hugepages:
Рассчитайте необходимое количество больших страниц, как обсуждалось ранее, и установите соответствующее значение.

sysctl -w vm.nr_hugepages=16384

Настройка памяти для оптимальной работы PostgreSQL включает несколько ключевых параметров, которые позволяют эффективно управлять использованием оперативной памяти и минимизировать использование swap. Вот подробное объяснение каждого параметра:

Общие настройки памяти
1. vm.overcommit_memory
Этот параметр контролирует политику выделения памяти ядром.

Значения:

0: Параметр по умолчанию. Ядро пытается угадать, сколько памяти требуется процессам.
1: Ядро разрешает выделение памяти с превышением реальной физической памяти.
2: Ядро запрещает выделение памяти с превышением реальной физической памяти. Рекомендуется для систем с базами данных, так как позволяет избежать ситуаций, когда PostgreSQL пытается использовать больше памяти, чем доступно.
Рекомендуемое значение:


sysctl -w vm.overcommit_memory=2
2. vm.swappiness
Этот параметр определяет, как агрессивно ядро будет использовать swap пространство. Значение от 0 до 100, где 0 означает минимальное использование swap.

Рекомендуемое значение:

sysctl -w vm.swappiness=1
3. vm.dirty_background_ratio и vm.dirty_ratio
Эти параметры управляют поведением ядра при записи данных на диск.

vm.dirty_background_ratio: Процент памяти, при достижении которого фоновые процессы начинают сбрасывать данные на диск.

Рекомендуемое значение:

sysctl -w vm.dirty_background_ratio=5
vm.dirty_ratio: Процент памяти, при достижении которого все процессы начинают сбрасывать данные на диск.

Рекомендуемое значение:

sysctl -w vm.dirty_ratio=15
Настройки больших страниц

Большие страницы (Huge Pages) позволяют улучшить производительность за счет уменьшения накладных расходов на управление памятью.

Использование огромных страниц (huge pages) снижает накладные расходы при работе с большими непрерывными блоками памяти, что характерно для Postgres Pro, особенно при большом объёме shared_buffers. Чтобы такие страницы можно было задействовать в Postgres Pro, ядро должно быть собрано с параметрами CONFIG_HUGETLBFS=y и CONFIG_HUGETLB_PAGE=y. Также вам понадобится настроить ОС, чтобы она могла выделить достаточное количество огромных страниц нужного размера. Чтобы определить требуемое количество огромных страниц, узнайте значение параметра shared_memory_size_in_huge_pages, воспользовавшись командой postgres. Обратите внимание, что узнать значение этого вычисляемого параметра можно только при остановленном сервере. Например, вы можете получить:
grep Hugepagesize /proc/meminfo

Расчет необходимого количества больших страниц
Определение общего объема памяти, используемой PostgreSQL
Основное внимание нужно уделить параметру shared_buffers в конфигурации PostgreSQL.
Формула: необходимое количество больших страниц = shared_buffers / размер большой страницы
или
$ postgres -D $PGDATA -C shared_memory_size_in_huge_pages
В Linux стандартный размер большой страницы составляет 2MB, но это можно проверить с помощью команды:
3170
$ grep ^Hugepagesize /proc/meminfo
Hugepagesize:       2048 kB
$ ls /sys/kernel/mm/hugepages
hugepages-1048576kB  hugepages-2048kB
В этом примере размер по умолчанию составляет 2 МБ, но задав в параметре huge_page_size 2 МБ или 1 ГБ явным образом, вы получите в shared_memory_size_in_huge_pages пересчитанное количество страниц. В данном примере серверу потребуется 3170 огромных страниц, но можно запросить и больше, если огромные страницы будут использоваться и другими программами в этой системе. Выбранное значение можно задать так:

# sysctl -w vm.nr_hugepages=3170
Не забудьте добавить этот параметр в /etc/sysctl.conf, чтобы он действовал и после перезагрузки. Если же размер огромных страниц отличается от подразумеваемого по умолчанию, их количество можно задать так:

# echo 3170 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
Также можно задать эти параметры во время загрузки ОС, установив соответствующие параметры ядра, например hugepagesz=2M hugepages=3170.

Иногда ядро не может сразу выделить запрошенное количество огромных страниц из-за фрагментации, поэтому может потребоваться повторить эту команду или перезагрузить систему. (Немедленно после перезагрузки должен быть свободен больший объём памяти для преобразования в огромные страницы.) Чтобы проверить текущую ситуацию с размещением огромных страниц определённого размера, выполните:

$ cat /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
Также может потребоваться дать пользователю операционной системы, запускающему сервер БД, право использовать огромные страницы, установив его группу в vm.hugetlb_shm_group с помощью sysctl, и/или разрешить блокировать память, выполнив ulimit -l.

По умолчанию Postgres Pro пытается использовать огромные страницы стандартного размера, а в противном случае переходит к обычным страницам. Чтобы задействовать огромные страницы принудительно, можно установить для huge_pages значение on в postgresql.conf. Заметьте, что с таким значением Postgres Pro не сможет запуститься, если не получит достаточного количества огромных страниц.

Более подробно о механизме огромных страниц в Linux можно узнать в документации ядра: https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt.

# Например, при shared_buffers = 32GB и размере большой страницы 2MB:
32GB = 32 * 1024MB = 32768MB
необходимое количество больших страниц = 32768MB / 2MB = 16384
4. Настройка количества больших страниц в системе
Установите параметр vm.nr_hugepages:

sysctl -w vm.nr_hugepages=16384
Пример настройки в файле /etc/sysctl.conf
Чтобы настройки сохранялись после перезагрузки, добавьте их в файл /etc/sysctl.conf:


vm.overcommit_memory = 2
vm.swappiness = 1
vm.dirty_background_ratio = 5
vm.dirty_ratio = 15
vm.nr_hugepages = 16384
Проверка использования больших страниц
После настройки и перезапуска PostgreSQL, вы можете проверить использование больших страниц с помощью команды:


grep Huge /proc/meminfo
Настройка PostgreSQL для использования больших страниц
Добавьте или измените параметр huge_pages в конфигурационном файле PostgreSQL (postgresql.conf):


huge_pages = on
После внесения изменений перезапустите PostgreSQL для применения настроек.

Эти настройки помогут вам оптимизировать использование оперативной памяти, что приведет к улучшению производительности и стабильности работы PostgreSQL.